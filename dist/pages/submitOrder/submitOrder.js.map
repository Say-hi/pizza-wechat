{"version":3,"sources":["pages/submitOrder/submitOrder.js"],"names":["app","getApp","Page","data","chooseAddress","that","wx","success","res","telNumber","setStorageSync","setData","needSetting","addressInfo","fail","getSetting","authSetting","setToast","content","openSetting","choosePay","showActionSheet","itemList","itemColor","lostTime","orderSubmit","tapIndex","removeStorageSync","calculateMoney","useCoupon","allMoney","dispatch_fee","balance","showLostTime","startTime","console","log","Date","getTime","toLocaleString","endTime","timer","setInterval","clearInterval","setTimeout","navigateBack","delta","lost","parseInt","timeText","getOrderDetail","oId","type","wxrequest","url","getUrl","detail","session3rd","gs","o_id","hideLoading","code","userName","name","phone","provinceName","address","menuArr","coupon_price","price","time","orderInfo","msg","orderdata","v","checked","push","s_id","id","num","orderBuy","cityName","countyName","detailInfo","cd_id","onLoad","options","shop","orderId","money","sendTime","onReady","onShow","onHide","onUnload","onPullDownRefresh"],"mappings":"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","file":"submitOrder.js","sourcesContent":["// 获取全局应用程序实例对象\nconst app = getApp()\n\n// 创建页面实例对象\nPage({\n  /**\n   * 页面的初始数据\n   */\n  data: {},\n  // 选择地址\n  chooseAddress () {\n    let that = this\n    wx.chooseAddress({\n      success (res) {\n        if (res.telNumber) { // 获取信息成功\n          wx.setStorageSync('addressInfo', res)\n          that.setData({\n            needSetting: false,\n            addressInfo: res\n          })\n        }\n      },\n      fail () {\n        wx.getSetting({\n          success (res) {\n            if (!res.authSetting['scope.address']) {\n              that.setData({\n                needSetting: true\n              })\n              app.setToast(that, {content: '需授权获取地址信息'})\n            }\n          }\n        })\n      }\n    })\n  },\n  // 获取设置\n  openSetting () {\n    let that = this\n    wx.openSetting({\n      success (res) {\n        // console.log(res)\n        if (res.authSetting['scope.address']) {\n          that.setData({\n            needSetting: false\n          })\n          that.chooseAddress()\n        }\n      }\n    })\n  },\n  // 选择支付方式\n  choosePay () {\n    if (!this.data.addressInfo) return app.setToast(this, {content: '请选择您的收货地址'})\n    let that = this\n    wx.showActionSheet({\n      itemList: ['微信支付', '余额支付'],\n      itemColor: '#333',\n      success (res) {\n        if (that.data.lostTime) {\n\n        } else {\n          that.orderSubmit(res.tapIndex)\n        }\n        wx.removeStorageSync('goodsStorage')\n        wx.removeStorageSync('useCoupon')\n      }\n    })\n  },\n  // 计算价格\n  calculateMoney () {\n    this.setData({\n      calculateMoney: this.data.useCoupon ? this.data.allMoney * 1 + this.data.dispatch_fee * 1 - this.data.useCoupon.balance : this.data.allMoney * 1 + this.data.dispatch_fee * 1\n    })\n  },\n  // 倒计时\n  showLostTime (startTime) {\n    console.log(new Date().getTime())\n    console.log(new Date(startTime * 1000).toLocaleString())\n    let endTime = startTime * 1000 + 900000 // 超时15分钟\n    let timer = setInterval(() => {\n      if (endTime - new Date().getTime() <= 0) {\n        // todo 取消订单\n        clearInterval(timer)\n        app.setToast(this, {content: '该订单超时支付已取消'})\n        setTimeout(() => {\n          wx.navigateBack({\n            delta: 1\n          })\n        }, 1500)\n        return\n      }\n      let lost = parseInt((endTime - (new Date().getTime())) / 1000)\n      // let m = parseInt(lost / 60)\n      // let s = lost % 60\n      this.setData({\n        timeText: parseInt(lost / 60) === 0 ? lost % 60 + '秒' : parseInt(lost / 60) + '分' + lost % 60 + '秒'\n      })\n    }, 100)\n  },\n  // 获取订单详情\n  getOrderDetail (oId, type) {\n    let that = this\n    app.wxrequest({\n      url: app.getUrl().detail,\n      data: {\n        session3rd: app.gs(),\n        o_id: oId\n      },\n      success (res) {\n        wx.hideLoading()\n        if (res.data.code === '200') {\n          let addressInfo = {\n            userName: res.data.data.name,\n            telNumber: res.data.data.phone,\n            provinceName: res.data.data.address\n          }\n          that.setData({\n            addressInfo,\n            menuArr: res.data.data.detail,\n            dispatch_fee: res.data.data.dispatch_fee,\n            coupon_price: res.data.data.coupon_price,\n            calculateMoney: res.data.data.price,\n            type,\n            /*eslint-disable*/\n            lostTime: type === 'second' ? true : false\n          })\n          that.showLostTime(res.data.data.time)\n          that.setData({\n            orderInfo: res.data.data\n          })\n        } else {\n          app.setToast(that, {content: res.data.msg})\n        }\n      }\n    })\n  },\n  // 提交订单\n  orderSubmit () {\n    let that = this\n    let orderdata = []\n    for (let v of this.data.menuArr) {\n      if (v.checked) {\n        orderdata.push({s_id: v.id || v.s_id, num: v.num})\n      }\n    }\n    app.wxrequest({\n      url: app.getUrl().orderBuy,\n      data: {\n        session3rd: app.gs(),\n        name: that.data.addressInfo.userName,\n        phone: that.data.addressInfo.telNumber,\n        address: that.data.addressInfo.provinceName + that.data.addressInfo.cityName + that.data.addressInfo.countyName + that.data.addressInfo.detailInfo,\n        data: orderdata,\n        cd_id: that.data.useCoupon ? that.data.useCoupon.cd_id : ''\n      },\n      success (res) {\n        wx.hideLoading()\n        if (res.data.code === '200') {\n          // console.log(res)\n          console.log(res.data.data)\n        } else {\n          app.setToast(that, {content: res.data.msg})\n        }\n      }\n    })\n  },\n  /**\n   * 生命周期函数--监听页面加载\n   */\n  onLoad (options) {\n    /*eslint-disable*/\n    if (options.type === 'second') {\n      this.getOrderDetail(options.id, options.type)\n    } else {\n      this.setData({\n        dispatch_fee: app.gs('shop').shop.dispatch_fee,\n        menuArr: app.gs('goodsStorage')\n      })\n    }\n    this.setData({\n      orderId: options.id,\n      allMoney: options.money || 0,\n      sendTime: new Date(new Date().getTime() + 1500000).toLocaleString()\n    })\n    if (options.time) {\n      this.showLostTime(options.time)\n    }\n    // this.calculateMoney()\n    // TODO: onLoad\n  },\n\n  /**\n   * 生命周期函数--监听页面初次渲染完成\n   */\n  onReady () {\n    // TODO: onReady\n  },\n\n  /**\n   * 生命周期函数--监听页面显示\n   */\n  onShow () {\n    if (app.gs('useCoupon')) {\n      this.setData({\n        useCoupon: app.gs('useCoupon')\n      })\n    }\n    if (app.gs('addressInfo') && !this.data.orderId) {\n      this.setData({\n        addressInfo: app.gs('addressInfo')\n      })\n    }\n    this.calculateMoney()\n    // TODO: onShow\n  },\n\n  /**\n   * 生命周期函数--监听页面隐藏\n   */\n  onHide () {\n    // TODO: onHide\n  },\n\n  /**\n   * 生命周期函数--监听页面卸载\n   */\n  onUnload () {\n    wx.removeStorageSync('useCoupon')\n    // TODO: onUnload\n  },\n\n  /**\n   * 页面相关事件处理函数--监听用户下拉动作\n   */\n  onPullDownRefresh () {\n    // TODO: onPullDownRefresh\n  }\n})\n"]}